version: "3.9"

services:
  # ==============================
  # DB: MariaDB
  # ==============================
  nyd-mariadb:
    image: mariadb:10.11
    container_name: nyd-mariadb
    restart: unless-stopped
    environment:
      # .env 에서 가져오는 값들
      MARIADB_ROOT_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      TZ: "${TZ}"
    ports:
      - "3306:3306"
    volumes:
      # 로컬 mysql-data 디렉터리를 DB 데이터 경로로 사용
      - ./mysql-data:/var/lib/mysql
      - ./mariadb/custom.cnf:/etc/mysql/conf.d/custom.cnf:ro
      - ./logs/mariadb:/var/log/mysql
      - ./logrotate/mariadb-logrotate.conf:/etc/logrotate.d/mariadb
    networks:
      - nyd-net

  # ==============================
  # Cache: Redis
  # ==============================
  nyd-redis:
    image: redis:7.2-alpine
    container_name: nyd-redis
    restart: unless-stopped
    # redis.conf + --requirepass 로 비밀번호 적용
    command: >
      redis-server /etc/redis/redis.conf --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
      - ./redis/redis.conf:/etc/redis/redis.conf:ro
      - ./logs/redis:/var/log/redis
      - ./logrotate/redis-logrotate.conf:/etc/logrotate.d/redis
    environment:
      # 컨테이너 내부에서도 REDIS_PASSWORD 환경변수 사용 가능
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      TZ: "${TZ}"
    networks:
      - nyd-net

  # ==============================
  # Agentend: FastAPI (8000)
  # ==============================
  yame-agentend:
    build:
      context: ../AICC6/second_project/YAME(Your_Assessment_for_Medical_Evaluation)/agentend
      dockerfile: Dockerfile
    container_name: yame-agentend
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      DB_HOST: nyd-mariadb
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      REDIS_HOST: nyd-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      TZ: "${TZ}"
    depends_on:
      - nyd-mariadb
      - nyd-redis
    networks:
      - nyd-net

  # ==============================
  # Backend: Next.js (3000)
  # ==============================
  yame-backend:
    build:
      context: ../AICC6/second_project/YAME(Your_Assessment_for_Medical_Evaluation)/backend
      dockerfile: Dockerfile
    container_name: yame-backend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      API_AGENTEND_URL: http://yame-agentend:8000
      DB_HOST: nyd-mariadb
      DB_PORT: 3306
      DB_USER: root
      DB_PASSWORD: "${MARIADB_ROOT_PASSWORD}"
      REDIS_HOST: nyd-redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: "${REDIS_PASSWORD}"
      TZ: "${TZ}"
      NODE_ENV: development
    depends_on:
      - yame-agentend
      - nyd-mariadb
      - nyd-redis
    networks:
      - nyd-net

  # ==============================
  # Frontend: NestJS (3001)
  # ==============================
  yame-frontend:
    build:
      context: ../AICC6/second_project/YAME(Your_Assessment_for_Medical_Evaluation)/frontend
      dockerfile: Dockerfile
    container_name: yame-frontend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      BACKEND_BASE_URL: http://yame-backend:3000
      TZ: "${TZ}"
      NODE_ENV: development
    depends_on:
      - yame-backend
    networks:
      - nyd-net

  # ==============================
  # Nginx: 전체 진입점 (8080 → 80)
  # ==============================
  yame-nginx:
    image: nginx:1.27-alpine
    container_name: yame-nginx
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - yame-backend
      - yame-frontend
      - yame-agentend
    networks:
      - nyd-net

networks:
  nyd-net:
    driver: bridge

volumes:
  mariadb-data:
  redis-data:
